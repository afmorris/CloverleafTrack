@using Slugify
@model MeetDetailsViewModel

@{
    ViewBag.Title = Model.Name;
}

@functions {
    bool IsRelay(string athleteName)
    {
        return athleteName?.Contains("|~|") ?? false;
    }

    string[] GetRelayAthletes(string athleteName)
    {
        return athleteName?.Split("|~|") ?? Array.Empty<string>();
    }
    
    string GetCategoryName(CloverleafTrack.Models.Enums.EventCategory category)
    {
        return category switch
        {
            CloverleafTrack.Models.Enums.EventCategory.Sprints => "Sprints",
            CloverleafTrack.Models.Enums.EventCategory.Distance => "Distance",
            CloverleafTrack.Models.Enums.EventCategory.Throws => "Throws",
            CloverleafTrack.Models.Enums.EventCategory.Jumps => "Jumps",
            CloverleafTrack.Models.Enums.EventCategory.Relays => "Relays",
            CloverleafTrack.Models.Enums.EventCategory.Hurdles => "Hurdles",
            _ => "Other"
        };
    }
}


<!-- Main Content -->
<div class="max-w-7xl mx-auto px-6">

    <!-- Header -->
    <div class="mb-8">
        <div class="mb-4">
            <a asp-controller="Seasons" asp-action="Details" asp-route-name="@Model.SeasonName" class="text-gray-600 dark:text-gray-400 text-sm mb-2 inline-block">
                ‚Üê Back to @Model.SeasonName Season
            </a>
        </div>
        <h1 class="text-4xl font-bold text-gray-900 dark:text-white">@Model.Name</h1>
        
        <div class="flex flex-wrap gap-6 text-gray-600 dark:text-gray-300">
            <div class="flex items-center gap-2">
                <span class="text-xl">üìÖ</span>
                <span>@Model.Date.ToString("MMMM d, yyyy")</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xl">üìç</span>
                <span>@Model.LocationName@(string.IsNullOrEmpty(Model.LocationCity) ? "" : $", {Model.LocationCity}")@(string.IsNullOrEmpty(Model.LocationState) ? "" : $", {Model.LocationState}")</span>
            </div>
            <div class="flex items-center gap-2">
                @if (Model.Environment == CloverleafTrack.Models.Enums.Environment.Indoor)
                {
                    <span class="px-3 py-1 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/40 dark:to-blue-800/40 text-blue-700 dark:text-blue-300 rounded-lg border border-blue-200 dark:border-blue-700/30 text-sm font-medium">
                        üè¢ Indoor
                    </span>
                }
                else
                {
                    <span class="px-3 py-1 bg-gradient-to-br from-yellow-50 to-yellow-100 dark:from-yellow-900/40 dark:to-yellow-800/40 text-yellow-700 dark:text-yellow-300 rounded-lg border border-yellow-200 dark:border-yellow-700/30 text-sm font-medium">
                        ‚òÄÔ∏è Outdoor
                    </span>
                }
            </div>
            @if (Model.HandTimed)
            {
                <div class="flex items-center gap-2">
                    <span class="px-3 py-1 bg-gray-700 text-gray-300 rounded-lg border border-gray-600 text-sm font-medium">
                        ‚è±Ô∏è Hand-Timed
                    </span>
                </div>
            }
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="mb-12">
        <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Meet Summary</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/40 dark:to-purple-800/40 rounded-xl p-6 border border-purple-200 dark:border-purple-700/30 shadow-sm">
                <div class="text-sm text-purple-700 dark:text-purple-300 mb-2 font-semibold uppercase tracking-wide">Total Performances</div>
                <div class="text-4xl font-bold text-purple-900 dark:text-purple-100">@Model.TotalPerformances</div>
            </div>
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/40 dark:to-blue-800/40 rounded-xl p-6 border border-blue-200 dark:border-blue-700/30 shadow-sm">
                <div class="text-sm text-blue-700 dark:text-blue-300 mb-2 font-semibold uppercase tracking-wide">Athletes</div>
                <div class="text-4xl font-bold text-blue-900 dark:text-blue-100">@Model.UniqueAthletes</div>
            </div>
            <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 dark:from-yellow-900/40 dark:to-yellow-800/40 rounded-xl p-6 border border-yellow-200 dark:border-yellow-700/30 shadow-sm">
                <div class="text-sm text-yellow-700 dark:text-yellow-300 mb-2 font-semibold uppercase tracking-wide">School Records</div>
                <div class="text-4xl font-bold text-yellow-900 dark:text-yellow-100">@Model.TotalSchoolRecords</div>
            </div>
            <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/40 dark:to-green-800/40 rounded-xl p-6 border border-green-200 dark:border-green-700/30 shadow-sm">
                <div class="text-sm text-green-700 dark:text-green-300 mb-2 font-semibold uppercase tracking-wide">Personal Records</div>
                <div class="text-4xl font-bold text-green-900 dark:text-green-100">@Model.TotalPRs</div>
            </div>
        </div>
    </div>

    <!-- Results by Gender -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Boys Results -->
        <div>
            <h2 class="text-2xl font-bold mb-6 text-blue-600 dark:text-blue-400 flex items-center gap-2">
                <span>‚ôÇ</span>
                <span>Boys</span>
            </h2>
            
        @if (Model.BoysEvents.Any())
        {
            var boysGrouped = Model.BoysEvents.GroupBy(e => e.EventCategory).OrderBy(g => g.Key);
            
            @foreach (var categoryGroup in boysGrouped)
            {
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">@GetCategoryName(categoryGroup.Key)</h3>
                    
                    <div class="space-y-4">
                        @foreach (var eventGroup in categoryGroup)
                        {
                            <div class="event-card bg-gray-800/50 border border-gray-700 rounded-xl overflow-hidden">
                                <div class="bg-gradient-to-r from-blue-900/30 to-gray-800/50 border-b border-gray-700 px-5 py-3">
                                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">@eventGroup.EventName</h4>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-sm">
                                        <thead class="border-b border-gray-700">
                                            <tr class="text-gray-400 text-xs">
                                                <th class="px-5 py-3 text-left font-medium">Athlete</th>
                                                <th class="px-5 py-3 text-left font-medium">Mark</th>
                                                <th class="px-5 py-3 text-center font-medium">Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var perf in eventGroup.Performances)
                                            {
                                                <tr class="border-t border-gray-700/50 hover:bg-gray-700/30 transition-colors">
                                                    <td class="px-5 py-3">
                                                        @if (IsRelay(perf.AthleteName))
                                                        {
                                                            <div class="space-y-1">
                                                                @foreach (var athlete in GetRelayAthletes(perf.AthleteName))
                                                                {
                                                                    var split = athlete.Split(' ');
                                                                    if (split.Length >= 2)
                                                                    {
                                                                        var firstName = split[0];
                                                                        var lastName = split[1];
                                                                        var helper = new SlugHelper();
                                                                        var slug = helper.GenerateSlug($"{firstName}-{lastName}");
                                                                        
                                                                        <div class="text-gray-300">
                                                                            <span class="text-gray-500 mr-2">‚Ä¢</span>
                                                                            <a asp-controller="Roster" asp-action="Details" asp-route-slug="@slug" class="underline">
                                                                                @athlete
                                                                            </a>
                                                                        </div>
                                                                    }
                                                                }
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            var split = perf.AthleteName.Split(' ');
                                                            if (split.Length >= 2)
                                                            {
                                                                var firstName = split[0];
                                                                var lastName = split[1];
                                                                var helper = new SlugHelper();
                                                                var slug = helper.GenerateSlug($"{firstName}-{lastName}");

                                                                <a asp-controller="Roster" asp-action="Details" asp-route-slug="@slug" class="text-gray-900 dark:text-white underline">
                                                                    @perf.AthleteName
                                                                </a>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-gray-900 dark:text-white">@perf.AthleteName</span>
                                                            }
                                                        }
                                                    </td>
                                                    <td class="px-5 py-3">
                                                        <span class="font-mono font-semibold text-lg text-gray-900 dark:text-white">@perf.Performance</span>
                                                    </td>
                                                    <td class="px-5 py-3">
                                                        <div class="flex justify-center gap-2 flex-wrap">
                                                            @if (perf.IsSchoolRecord)
                                                            {
                                                                <span class="inline-block px-2 py-1 text-xs font-semibold rounded bg-yellow-500/20 text-yellow-400 border border-yellow-500/30" title="School Record">
                                                                    SR
                                                                </span>
                                                            }
                                                            @if (perf.IsPersonalBest)
                                                            {
                                                                <span class="inline-block px-2 py-1 text-xs font-semibold rounded bg-green-500/20 text-green-400 border border-green-500/30" title="Personal Best">
                                                                    PR
                                                                </span>
                                                            }
                                                            @if (perf.IsSeasonBest)
                                                            {
                                                                <span class="inline-block px-2 py-1 text-xs font-semibold rounded bg-blue-500/20 text-blue-400 border border-blue-500/30" title="Season Best">
                                                                    SB
                                                                </span>
                                                            }
                                                            @if (perf.AllTimeRank.HasValue && perf.AllTimeRank <= 10)
                                                            {
                                                                <span class="inline-block px-2 py-1 text-xs font-semibold rounded bg-purple-500/20 text-purple-400 border border-purple-500/30" title="All-Time Top 10">
                                                                    #@perf.AllTimeRank AT
                                                                </span>
                                                            }
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div class="p-8 bg-gray-800/50 border border-gray-700 rounded-xl text-center">
                <p class="text-gray-400">No boys' results for this meet.</p>
            </div>
        }
        </div>

        <!-- Girls Results -->
        <div>
            <h2 class="text-2xl font-bold mb-6 text-pink-600 dark:text-pink-400 flex items-center gap-2">
                <span>‚ôÄ</span>
                <span>Girls</span>
            </h2>
            
        @if (Model.GirlsEvents.Any())
        {
            var girlsGrouped = Model.GirlsEvents.GroupBy(e => e.EventCategory).OrderBy(g => g.Key);
            
            @foreach (var categoryGroup in girlsGrouped)
            {
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">@GetCategoryName(categoryGroup.Key)</h3>
                    
                    <div class="space-y-4">
                        @foreach (var eventGroup in categoryGroup)
                        {
                            <div class="event-card bg-gray-800/50 border border-gray-700 rounded-xl overflow-hidden">
                                <div class="bg-gradient-to-r from-pink-900/30 to-gray-800/50 border-b border-gray-700 px-5 py-3">
                                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">@eventGroup.EventName</h4>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-sm">
                                        <thead class="border-b border-gray-700">
                                            <tr class="text-gray-400 text-xs">
                                                <th class="px-5 py-3 text-left font-medium">Athlete</th>
                                                <th class="px-5 py-3 text-left font-medium">Mark</th>
                                                <th class="px-5 py-3 text-center font-medium">Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var perf in eventGroup.Performances)
                                            {
                                                <tr class="border-t border-gray-700/50 hover:bg-gray-700/30 transition-colors">
                                                    <td class="px-5 py-3">
                                                        @if (IsRelay(perf.AthleteName))
                                                        {
                                                            <div class="space-y-1">
                                                                @foreach (var athlete in GetRelayAthletes(perf.AthleteName))
                                                                {
                                                                    var split = athlete.Split(' ');
                                                                    if (split.Length >= 2)
                                                                    {
                                                                        var firstName = split[0];
                                                                        var lastName = split[1];
                                                                        var helper = new SlugHelper();
                                                                        var slug = helper.GenerateSlug($"{firstName}-{lastName}");
                                                                        
                                                                        <div class="text-gray-300">
                                                                            <span class="text-gray-500 mr-2">‚Ä¢</span>
                                                                            <a asp-controller="Roster" asp-action="Details" asp-route-slug="@slug" class="underline">
                                                                                @athlete
                                                                            </a>
                                                                        </div>
                                                                    }
                                                                }
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            var split = perf.AthleteName.Split(' ');
                                                            if (split.Length >= 2)
                                                            {
                                                                var firstName = split[0];
                                                                var lastName = split[1];
                                                                var helper = new SlugHelper();
                                                                var slug = helper.GenerateSlug($"{firstName}-{lastName}");

                                                                <a asp-controller="Roster" asp-action="Details" asp-route-slug="@slug" class="text-gray-900 dark:text-white underline">
                                                                    @perf.AthleteName
                                                                </a>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-gray-900 dark:text-white">@perf.AthleteName</span>
                                                            }
                                                        }
                                                    </td>
                                                    <td class="px-5 py-3">
                                                        <span class="font-mono font-semibold text-lg text-gray-900 dark:text-white">@perf.Performance</span>
                                                    </td>
                                                    <td class="px-5 py-3">
                                                        <div class="flex justify-center gap-2 flex-wrap">
                                                            @if (perf.IsSchoolRecord)
                                                            {
                                                                <span class="inline-block px-2 py-1 text-xs font-semibold rounded bg-yellow-500/20 text-yellow-400 border border-yellow-500/30" title="School Record">
                                                                    SR
                                                                </span>
                                                            }
                                                            @if (perf.IsPersonalBest)
                                                            {
                                                                <span class="inline-block px-2 py-1 text-xs font-semibold rounded bg-green-500/20 text-green-400 border border-green-500/30" title="Personal Best">
                                                                    PR
                                                                </span>
                                                            }
                                                            @if (perf.IsSeasonBest)
                                                            {
                                                                <span class="inline-block px-2 py-1 text-xs font-semibold rounded bg-blue-500/20 text-blue-400 border border-blue-500/30" title="Season Best">
                                                                    SB
                                                                </span>
                                                            }
                                                            @if (perf.AllTimeRank.HasValue && perf.AllTimeRank <= 10)
                                                            {
                                                                <span class="inline-block px-2 py-1 text-xs font-semibold rounded bg-purple-500/20 text-purple-400 border border-purple-500/30" title="All-Time Top 10">
                                                                    #@perf.AllTimeRank AT
                                                                </span>
                                                            }
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div class="p-8 bg-gray-800/50 border border-gray-700 rounded-xl text-center">
                <p class="text-gray-400">No girls' results for this meet.</p>
            </div>
        }
        </div>
    </div>

</div>
